---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import { getCollection, render } from 'astro:content';
import { getGitHubRepo } from '../../lib/github';

export async function getStaticPaths() {
  const tools = await getCollection('tools');
  return tools.map((tool) => ({
    params: { slug: tool.id.replace(/\.md$/, '') },
    props: { tool },
  }));
}

const { tool } = Astro.props;
const { Content } = await render(tool);
const repo = getGitHubRepo(tool.data.github_url);

const langColors: Record<string, string> = {
  'C#': '#178600',
  'C++': '#f34b7d',
  'Rust': '#dea584',
  'TypeScript': '#3178c6',
  'JavaScript': '#f1e05a',
  'Python': '#3572A5',
  'PowerShell': '#012456',
};

const langColor = tool.data.language ? langColors[tool.data.language] || '#8b949e' : null;
---

<BaseLayout
  title={`${tool.data.name} ‚Äî Tiny Tool Town üèòÔ∏è`}
  description={tool.data.tagline}
  {...(tool.data.theme ? { theme: tool.data.theme } : {})}
>
  <Header />

  <main id="main" class="container">
    <div class="tool-detail">
      <!-- Breadcrumb -->
      <nav class="breadcrumb">
        <a href="/">Home</a>
        <span class="sep">/</span>
        <a href="/tools/">Tools</a>
        <span class="sep">/</span>
        <span class="current">{tool.data.name}</span>
      </nav>

      <!-- Tool Header -->
      <div class="tool-header">
        <div class="tool-info">
          <h1 class="tool-name">{tool.data.name}</h1>
          <p class="tool-tagline">{tool.data.tagline}</p>

          <div class="tool-meta">
            <div class="tool-author">
              <img
                src={`https://github.com/${tool.data.author_github}.png?size=40`}
                alt={tool.data.author}
                class="author-avatar"
              />
              <div>
                <a href={`/tools/?q=${encodeURIComponent(tool.data.author.toLowerCase())}`} class="author-name">{tool.data.author}</a>
              </div>
            </div>

            <div class="tool-badges">
              {tool.data.language && (
                <span class="badge lang-badge">
                  <span class="lang-dot" style={`background: ${langColor}`}></span>
                  {tool.data.language}
                </span>
              )}
              {tool.data.license && (
                <span class="badge license-badge">üìÑ {tool.data.license}</span>
              )}
              {repo && (
                <a href={`https://github.com/${repo}`} target="_blank" rel="noopener" class="badge star-badge" id="star-badge" data-repo={repo}>
                  ‚≠ê <span id="star-count">‚Ä¶</span>
                </a>
              )}
            </div>
          </div>

          <div class="tool-tags">
            {tool.data.tags.map((tag: string) => (
              <a href={`/tools/?tag=${tag}`} class="tag">{tag}</a>
            ))}
          </div>

          <div class="tool-actions">
            <a href={tool.data.github_url} class="btn btn-primary" target="_blank" rel="noopener">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
              View on GitHub
            </a>
            {tool.data.website_url && (
              <a href={tool.data.website_url} class="btn btn-secondary" target="_blank" rel="noopener">
                üåê Website
              </a>
            )}
          </div>
        </div>

        {tool.data.thumbnail && (
          <div class="tool-screenshot">
            <img src={tool.data.thumbnail} alt={`Screenshot of ${tool.data.name}`} />
          </div>
        )}
      </div>

      <!-- Tool Description -->
      <div class="tool-content">
        <Content />
      </div>

      <!-- AI-Generated Summary (clearly attributed) -->
      {tool.data.ai_summary && (
        <div class="copilot-summary" role="region" aria-label="AI-generated summary by GitHub Copilot">
          <div class="copilot-header">
            <div class="copilot-label">
              <svg class="copilot-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z" fill="currentColor" />
              </svg>
              <span class="copilot-title">Copilot says:</span>
              <span class="copilot-badge">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L14.09 8.26L20 9.27L15.55 13.97L16.91 20L12 16.9L7.09 20L8.45 13.97L4 9.27L9.91 8.26L12 2Z"/></svg>
                AI-generated
              </span>
            </div>
          </div>
          <p class="copilot-text">{tool.data.ai_summary}</p>
          {tool.data.ai_features && tool.data.ai_features.length > 0 && (
            <div class="copilot-features">
              <p class="copilot-features-label">Key features:</p>
              <ul class="copilot-feature-list">
                {tool.data.ai_features.map((feature: string) => (
                  <li class="copilot-feature-item">{feature}</li>
                ))}
              </ul>
            </div>
          )}
          <p class="copilot-disclaimer">This summary was generated by GitHub Copilot based on the project README.</p>
        </div>
      )}

      <!-- Back link -->
      <div class="back-link">
        <a href="/tools/">‚Üê Back to all tools</a>
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>

<style>
  .tool-detail {
    padding: 1.5rem 0 3rem;
    max-width: 900px;
    margin: 0 auto;
  }

  .breadcrumb {
    display: flex;
    gap: 0.5rem;
    font-size: 0.9rem;
    color: var(--color-text-muted);
    margin-bottom: 2rem;
  }

  .breadcrumb a {
    color: var(--color-text-muted);
  }

  .breadcrumb a:hover {
    color: var(--color-primary);
  }

  .sep { opacity: 0.4; }
  .current { color: var(--color-text); }

  .tool-header {
    margin-bottom: 2rem;
  }

  .tool-name {
    font-size: 2.5rem;
    font-weight: 900;
    line-height: 1.1;
    margin-bottom: 0.5rem;
  }

  .tool-tagline {
    font-size: 1.2rem;
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
  }

  .tool-meta {
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
  }

  .tool-author {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .author-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
  }

  .author-name {
    font-weight: 600;
    color: var(--color-text);
  }

  .tool-badges {
    display: flex;
    gap: 0.75rem;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.3rem 0.75rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 50px;
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  .lang-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
  }

  .star-badge {
    background: #007ec6;
    border-color: #007ec6;
    color: #fff;
    text-decoration: none;
    cursor: pointer;
    transition: opacity 0.2s;
  }

  .star-badge:hover {
    opacity: 0.85;
    color: #fff;
  }

  .tool-tags {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
    margin-bottom: 1.5rem;
  }

  .tag {
    font-size: 0.85rem;
    padding: 0.3rem 0.75rem;
    background: var(--color-tag-bg);
    color: var(--color-tag-text);
    border-radius: 50px;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s;
  }

  .tag:hover {
    background: rgba(61, 169, 252, 0.25);
    color: var(--color-accent);
  }

  .tool-actions {
    display: flex;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .tool-screenshot {
    margin-top: 2rem;
    border-radius: var(--radius-lg);
    overflow: hidden;
    border: 1px solid var(--color-border);
  }

  .tool-screenshot img {
    width: 100%;
    display: block;
  }

  .tool-content {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 2rem;
    margin: 2rem 0;
    line-height: 1.8;
    color: var(--color-text-muted);
    font-size: 1.05rem;
  }

  .tool-content :global(p) {
    margin-bottom: 1rem;
  }

  .tool-content :global(a) {
    color: var(--color-accent);
  }

  .tool-content :global(code) {
    background: rgba(255, 255, 255, 0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 4px;
    font-size: 0.9em;
  }

  .back-link {
    margin-top: 1rem;
  }

  .back-link a {
    color: var(--color-text-muted);
    font-weight: 500;
  }

  .back-link a:hover {
    color: var(--color-primary);
  }

  /* Copilot AI Summary ‚Äî clearly attributed */
  .copilot-summary {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.06), rgba(59, 130, 246, 0.06));
    border: 1px solid rgba(139, 92, 246, 0.25);
    border-left: 4px solid rgb(139, 92, 246);
    border-radius: var(--radius-lg);
    padding: 1.5rem;
    margin: 0 0 1.5rem;
    position: relative;
  }

  .copilot-header {
    margin-bottom: 0.75rem;
  }

  .copilot-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .copilot-icon {
    color: rgb(139, 92, 246);
    flex-shrink: 0;
  }

  .copilot-title {
    font-weight: 800;
    font-size: 1.05rem;
    color: rgb(139, 92, 246);
    letter-spacing: -0.01em;
  }

  .copilot-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.2rem 0.6rem;
    background: rgba(139, 92, 246, 0.15);
    color: rgb(167, 139, 250);
    border-radius: 50px;
    font-weight: 700;
    margin-left: auto;
  }

  .copilot-text {
    font-size: 1rem;
    color: var(--color-text-muted);
    line-height: 1.7;
    margin: 0;
    font-style: italic;
  }

  .copilot-features {
    margin-top: 1rem;
    padding-top: 0.75rem;
    border-top: 1px solid rgba(139, 92, 246, 0.15);
  }

  .copilot-features-label {
    font-size: 0.8rem;
    font-weight: 700;
    color: rgb(139, 92, 246);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin: 0 0 0.5rem;
  }

  .copilot-feature-list {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    gap: 0.4rem;
  }

  .copilot-feature-item {
    font-size: 0.9rem;
    color: var(--color-text-muted);
    padding: 0.3rem 0;
    line-height: 1.4;
  }

  .copilot-disclaimer {
    font-size: 0.7rem;
    color: var(--color-text-muted);
    opacity: 0.6;
    margin: 1rem 0 0;
    font-style: italic;
  }

  @media (max-width: 640px) {
    .tool-name { font-size: 1.75rem; }
    .tool-tagline { font-size: 1.05rem; }
    .tool-content { padding: 1.5rem; }
  }
</style>

<script>
  const badge = document.getElementById('star-badge');
  if (badge) {
    const repo = badge.dataset.repo;
    fetch(`https://api.github.com/repos/${repo}`)
      .then(r => r.ok ? r.json() : Promise.reject())
      .then(data => {
        const count = data.stargazers_count;
        const label = count >= 1000
          ? (count / 1000).toFixed(count >= 10000 ? 0 : 1) + 'k'
          : count.toString();
        document.getElementById('star-count')!.textContent = label;
      })
      .catch(() => { badge.style.display = 'none'; });
  }
</script>

---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import ToolCard from '../../components/ToolCard.astro';
import { getCollection } from 'astro:content';

const allTools = await getCollection('tools');
const tools = allTools.sort((a, b) =>
  new Date(b.data.date_added).getTime() - new Date(a.data.date_added).getTime()
);

const allTags = [...new Set(tools.flatMap(t => t.data.tags))].sort();
---

<BaseLayout title="Browse Tools ‚Äî Tiny Tool Town üèòÔ∏è" description="Explore all the tiny, delightful, open source tools in Tiny Tool Town.">
  <Header />

  <main class="container">
    <section class="browse-header">
      <h1>Browse the Town üèòÔ∏è</h1>
      <p class="browse-subtitle">{tools.length} tiny tools and counting</p>
    </section>

    <!-- Search & Filter -->
    <div class="filter-bar">
      <div class="search-box">
        <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        <input
          type="text"
          id="search"
          placeholder="Search tools..."
          class="search-input"
          autocomplete="off"
        />
      </div>
      <div class="tags-filter" id="tags-filter">
        <button class="tag-btn active" data-tag="all">All</button>
        {allTags.map(tag => (
          <button class="tag-btn" data-tag={tag}>{tag}</button>
        ))}
      </div>
    </div>

    <!-- Tool Grid -->
    <div class="tool-grid" id="tool-grid">
      {tools.map(tool => (
        <div class="tool-item"
          data-name={tool.data.name.toLowerCase()}
          data-tagline={tool.data.tagline.toLowerCase()}
          data-tags={tool.data.tags.join(',')}
        >
          <ToolCard
            name={tool.data.name}
            slug={tool.id.replace(/\.md$/, '')}
            tagline={tool.data.tagline}
            author={tool.data.author}
            author_github={tool.data.author_github}
            tags={tool.data.tags}
            language={tool.data.language}
            featured={tool.data.featured}
            thumbnail={tool.data.thumbnail}
          />
        </div>
      ))}
    </div>

    <div id="no-results" class="no-results" style="display: none;">
      <p>üîç No tools found. Try a different search?</p>
    </div>
  </main>

  <Footer />
</BaseLayout>

<script>
  const search = document.getElementById('search') as HTMLInputElement;
  const grid = document.getElementById('tool-grid')!;
  const items = grid.querySelectorAll('.tool-item');
  const tagButtons = document.querySelectorAll('.tag-btn');
  const noResults = document.getElementById('no-results')!;

  let activeTag = 'all';

  function filterTools() {
    const query = search.value.toLowerCase().trim();
    let visible = 0;

    items.forEach(item => {
      const el = item as HTMLElement;
      const name = el.dataset.name || '';
      const tagline = el.dataset.tagline || '';
      const tags = el.dataset.tags || '';

      const matchesSearch = !query || name.includes(query) || tagline.includes(query);
      const matchesTag = activeTag === 'all' || tags.split(',').includes(activeTag);

      if (matchesSearch && matchesTag) {
        el.style.display = '';
        visible++;
      } else {
        el.style.display = 'none';
      }
    });

    noResults.style.display = visible === 0 ? 'block' : 'none';
  }

  search.addEventListener('input', filterTools);

  tagButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      tagButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeTag = (btn as HTMLElement).dataset.tag || 'all';
      filterTools();
    });
  });
</script>

<style>
  .browse-header {
    padding: 2.5rem 0 1.5rem;
  }

  .browse-header h1 {
    font-size: 2rem;
    font-weight: 900;
  }

  .browse-subtitle {
    color: var(--color-text);
    opacity: 0.7;
    margin-top: 0.25rem;
  }

  .filter-bar {
    margin-bottom: 2rem;
  }

  .search-box {
    position: relative;
    margin-bottom: 1rem;
  }

  .search-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    color: var(--color-text-muted);
    pointer-events: none;
  }

  .search-input {
    width: 100%;
    padding: 0.85rem 1rem 0.85rem 2.75rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius);
    color: var(--color-text);
    font-size: 1rem;
    font-family: inherit;
    transition: border-color 0.2s;
  }

  .search-input::placeholder {
    color: var(--color-text-muted);
  }

  .search-input:focus {
    outline: none;
    border-color: var(--color-primary);
  }

  .tags-filter {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }

  .tag-btn {
    padding: 0.4rem 0.9rem;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: 50px;
    color: var(--color-text-muted);
    font-size: 0.85rem;
    font-family: inherit;
    cursor: pointer;
    transition: all 0.2s;
  }

  .tag-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .tag-btn.active {
    background: var(--color-primary);
    color: var(--color-bg);
    border-color: var(--color-primary);
  }

  .tool-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 1.5rem;
  }

  .no-results {
    text-align: center;
    padding: 3rem;
    color: var(--color-text-muted);
    font-size: 1.1rem;
  }
</style>
